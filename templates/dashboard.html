{{ define "content" }}
<div class="dashboard-container">
    <!-- Header with Stats -->
    <div class="dashboard-header">
        <h1>Dashboard</h1>
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value">{{ .TotalNotes }}</div>
                <div class="stat-label">Total Notes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ .PinnedCount }}</div>
                <div class="stat-label">Pinned</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ .StarredCount }}</div>
                <div class="stat-label">Starred</div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="dashboard-content">
        <!-- Filters Sidebar -->
        <aside class="filters-sidebar">
            <div class="filter-section">
                <div class="search-box">
                    <form method="get" action="/dashboard" id="search-form" class="search-form">
                        <div class="search-input-container">
                            <input type="text" name="search" placeholder="Search notes..."
                                   value="{{ .Search }}" class="search-input">
                            <button type="submit" class="search-button">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18">
                                    <path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 0 0 1.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 0 0-7.27 7.27c.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 0 0 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0 .41-.41.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                            </button>
                        </div>
                        <input type="hidden" name="page" value="1">
                    </form>
                </div>
            </div>

            <div class="filter-section">
                <h3>Quick Filters</h3>
                <div class="filter-options">
                    <a href="{{ if .FilterPinned }}{{ removeQueryParam "filter_pinned" }}{{ else }}{{ addQueryParam "filter_pinned" "true" }}{{ end }}"
                    class="filter-tag {{ if .FilterPinned }}active{{ end }}"
                    data-filter="pinned">
                    <svg width="16" height="16" viewBox="0 0 24 24" class="filter-icon">
                        <path d="M18 1l-6 4-6-4-6 5v7l12 10 12-10v-7z"/>
                    </svg>
                    Pinned
                    </a>
                    <a href="{{ if .FilterStarred }}{{ removeQueryParam "filter_starred" }}{{ else }}{{ addQueryParam "filter_starred" "true" }}{{ end }}"
                    class="filter-tag {{ if .FilterStarred }}active{{ end }}"
                    data-filter="starred">
                    <svg width="16" height="16" viewBox="0 0 24 24" class="filter-icon">
                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                    </svg>
                    Starred
                    </a>
                </div>
            </div>

            <div class="filter-section">
                <h3>Sort By</h3>
                <form method="get" action="/dashboard" class="sort-form">
                    {{ if .Search }}<input type="hidden" name="search" value="{{ .Search }}">{{ end }}
                    {{ if .FilterPinned }}<input type="hidden" name="filter_pinned" value="true">{{ end }}
                    {{ if .FilterStarred }}<input type="hidden" name="filter_starred" value="true">{{ end }}
                    {{ range .SelectedTags }}<input type="hidden" name="tag" value="{{ . }}">{{ end }}
                    <input type="hidden" name="page" value="1"> <!-- Always reset to page 1 when sorting -->
                    <select name="sort_by" onchange="this.form.submit()" class="sort-select">
                        <option value="created_at_desc" {{ if eq .SortBy "created_at_desc" }}selected{{ end }}>Newest First</option>
                        <option value="created_at_asc" {{ if eq .SortBy "created_at_asc" }}selected{{ end }}>Oldest First</option>
                        <option value="title_asc" {{ if eq .SortBy "title_asc" }}selected{{ end }}>Title (A-Z)</option>
                        <option value="title_desc" {{ if eq .SortBy "title_desc" }}selected{{ end }}>Title (Z-A)</option>
                    </select>
                </form>
            </div>

            <div class="filter-section">
                <h3>Tags</h3>
                <div class="tags-container">
                    {{ if .TagCloud }}
                    {{ range $tag, $count := .TagCloud }}
                    <a href="{{ toggleTag $tag }}"
                       class="tag-pill {{ if containsTag $tag }}active{{ end }}">
                        {{ $tag }} <span class="tag-count">{{ $count }}</span>
                    </a>
                    {{ end }}
                    {{ else }}
                    <p class="no-tags">No tags available</p>
                    {{ end }}
                </div>
            </div>
        </aside>

        <!-- Notes Grid -->
        <main class="notes-grid-container">
            <div class="notes-header">
                <h2>
                    {{ if .FilterPinned }}Pinned Notes
                    {{ else if .FilterStarred }}Starred Notes
                    {{ else if .Search }}Search Results
                    {{ else }}All Notes{{ end }}
                    {{ if .SelectedTags }}
                    with tags: {{ range .SelectedTags }}<span class="active-tag">{{ . }}</span>{{ end }}
                    {{ end }}
                </h2>
                <span class="notes-count">{{ len .Notes }} notes</span>
            </div>

            {{ if .Notes }}
            <div class="notes-grid">
                {{ range .Notes }}
                <div class="note-card {{ if .IsPinned }}pinned{{ end }} {{ if .IsStarred }}starred{{ end }}">
                    <div class="note-header">
                        <h3 class="note-title">{{ .Title }}</h3>
                        <div class="note-badges">
                            {{ if .IsPinned }}<span class="badge pinned-badge">Pinned</span>{{ end }}
                            {{ if .IsStarred }}<span class="badge starred-badge">Starred</span>{{ end }}
                        </div>
                    </div>

                    <div class="note-content">
                        {{ .Content | safeHTML }}
                    </div>

                    <div class="note-footer">
                        <div class="note-tags">
                            {{ if .Tags }}
                            {{ range split .Tags "," }}
                            <span class="tag">{{ . }}</span>
                            {{ end }}
                            {{ end }}
                        </div>
                        <div class="note-actions">
                            <a href="/notes/view/{{ .ID }}" class="action-button view-button" title="View note">
                                <svg width="16" height="16" viewBox="0 0 24 24">
                                    <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                </svg>
                            </a>
                            <button class="action-button download-button"
                                    data-title="{{ .Title }}"
                                    data-content="{{ .Content | safeHTML }}"
                                    title="Download note">
                                <svg width="16" height="16" viewBox="0 0 24 24">
                                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="note-date">{{ .CreatedAt.Format "Jan 2, 2006 at 3:04 PM" }}</div>
                </div>
                {{ end }}
            </div>
            {{ else }}
            <div class="empty-state">
                <svg class="empty-icon" viewBox="0 0 24 24">
                    <path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 9c-1.65 0-3-1.35-3-3s1.35-3 3-3 3 1.35 3 3-1.35 3-3 3zm0-4c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm6 10H6v-1.53c0-3.5 3.56-4.33 6-4.33s6 .83 6 4.33V18zm-9.5-2h7v-1.2c0-1.8-2.44-2.8-3.5-2.8s-3.5 1-3.5 2.8v1.2z"/>
                </svg>
                <h3>No notes found</h3>
                <p>Try adjusting your filters or create a new note</p>
                <a href="/notes/new" class="create-button">Create Note</a>
            </div>
            {{ end }}

            {{ if .Notes }}
            <div class="pagination">
                {{ if gt .Page 1 }}
                <a href="{{ addPageParam (sub .Page 1) }}" class="page-link">Previous</a>
                {{ end }}

                <span class="page-info">Page {{ .Page }} of {{ .TotalPages }}</span>

                {{ if lt .Page .TotalPages }}
                <a href="{{ addPageParam (add .Page 1) }}" class="page-link">Next</a>
                {{ end }}
            </div>
            {{ end }}
        </main>
    </div>
</div>

<style>
    /* Add this new style for active tags in the header */
    .active-tag {
        display: inline-block;
        margin-left: 0.5rem;
        padding: 0.25rem 0.5rem;
        background: var(--primary-light);
        color: white;
        border-radius: 12px;
        font-size: 0.75rem;
    }

    /* Rest of your existing styles... */
    :root {
        --primary: #4f46e5;
        --primary-light: #6366f1;
        --primary-dark: #4338ca;
        --secondary: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --info: #3b82f6;
        --light: #f9fafb;
        --dark: #111827;
        --gray: #6b7280;
        --light-gray: #e5e7eb;
        --border-radius: 8px;
        --card-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }


    /* Base Styles */
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        line-height: 1.5;
        color: var(--dark);
    }

    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    /* Header Styles */
    .dashboard-header {
        margin-bottom: 2rem;
    }

    .dashboard-header h1 {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 1rem;
        color: var(--dark);
    }

    .stats-container {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card {
        flex: 1;
        background: white;
        border-radius: var(--border-radius);
        padding: 1rem;
        box-shadow: var(--card-shadow);
        text-align: center;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--gray);
    }

    /* Dashboard Layout */
    .dashboard-content {
        display: grid;
        grid-template-columns: 260px 1fr;
        gap: 1.5rem;
    }

    @media (max-width: 1024px) {
        .dashboard-content {
            grid-template-columns: 1fr;
        }
    }

    /* Filters Sidebar */
    .filters-sidebar {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.25rem;
        box-shadow: var(--card-shadow);
        height: fit-content;
        position: sticky;
        top: 1rem;
    }

    .search-input-container {
        position: relative;
        display: flex;
        align-items: center;
    }

    .search-input {
        width: 100%;
        padding: 0.75rem 2.5rem 0.75rem 1rem;
        border: 1px solid var(--light-gray);
        border-radius: var(--border-radius);
        font-size: 0.9375rem;
        transition: all 0.2s;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .search-button {
        position: absolute;
        right: 0.75rem;
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--gray);
    }

    .search-button svg {
        width: 18px;
        height: 18px;
    }

    .search-button:hover {
        color: var(--primary);
    }

    .filters-sidebar {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.25rem;
        box-shadow: var(--card-shadow);
        height: fit-content;
        position: sticky;
        top: 1rem;
    }

    .filter-section {
        margin-bottom: 1.75rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--light-gray);
    }

    .filter-section:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .filter-section h3 {
        font-size: 0.9375rem;
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }

    .filter-section h3 svg {
        margin-right: 0.5rem;
        width: 16px;
        height: 16px;
        fill: var(--gray);
    }

    .filter-options {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .filter-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.5rem 0.875rem;
        background: var(--light);
        border-radius: 20px;
        font-size: 0.8125rem;
        font-weight: 500;
        color: var(--dark);
        text-decoration: none;
        transition: all 0.2s;
        border: 1px solid var(--light-gray);
    }

    .filter-tag:hover {
        background: var(--light-gray);
    }

    .filter-tag.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .filter-tag.active .filter-icon {
        fill: white;
    }

    .filter-icon {
        fill: var(--gray);
        width: 14px;
        height: 14px;
    }

    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .tag-pill {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        background: var(--light);
        border-radius: 20px;
        font-size: 0.8125rem;
        color: var(--dark);
        text-decoration: none;
        transition: all 0.2s;
        border: 1px solid var(--light-gray);
    }

    .tag-pill:hover {
        background: var(--light-gray);
    }

    .tag-pill.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .tag-count {
        margin-left: 0.25rem;
        font-size: 0.75rem;
        opacity: 0.8;
    }

    .clear-tags {
        margin-top: 0.5rem;
    }

    .clear-tag-link {
        font-size: 0.8125rem;
        color: var(--primary);
        text-decoration: none;
        transition: all 0.2s;
    }

    .clear-tag-link:hover {
        text-decoration: underline;
    }

    /* Improved sort select */
    .sort-select {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--light-gray);
        border-radius: var(--border-radius);
        font-size: 0.9375rem;
        background-color: white;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%236b7280'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 1rem;
    }

    .sort-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    /* Notes Grid */
    .notes-grid-container {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
    }

    .notes-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .notes-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--dark);
    }

    .notes-count {
        font-size: 0.875rem;
        color: var(--gray);
        background: var(--light);
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
    }

    .notes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.25rem;
    }

    /* Note Card */
    .note-card {
        background: white;
        border: 1px solid var(--light-gray);
        border-radius: var(--border-radius);
        padding: 1.25rem;
        transition: all 0.2s;
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .note-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-color: var(--primary-light);
    }

    .note-card.pinned {
        border-left: 3px solid var(--primary);
    }

    .note-card.starred {
        border-right: 3px solid var(--warning);
    }

    .note-header {
        margin-bottom: 0.75rem;
    }

    .note-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--dark);
        margin: 0;
        line-height: 1.4;
    }

    .note-badges {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        gap: 0.375rem;
    }

    .badge {
        font-size: 0.6875rem;
        font-weight: 500;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }

    .pinned-badge {
        background: rgba(79, 70, 229, 0.1);
        color: var(--primary);
    }

    .starred-badge {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning);
    }

    .note-content {
        color: var(--dark);
        font-size: 0.9375rem;
        line-height: 1.5;
        margin-bottom: 1rem;
        display: -webkit-box;
        -webkit-line-clamp: 4;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .note-footer {
        margin-top: auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .note-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.375rem;
    }

    .tag {
        background: var(--light);
        color: var(--dark);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.6875rem;
        font-weight: 500;
    }

    .note-actions {
        display: flex;
        gap: 0.5rem;
    }

    .action-button {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--light);
        border: none;
        color: var(--gray);
        cursor: pointer;
        transition: all 0.2s;
    }

    .action-button:hover {
        background: var(--primary);
        color: white;
    }

    .action-button svg {
        width: 16px;
        height: 16px;
        fill: currentColor;
    }

    .note-date {
        font-size: 0.75rem;
        color: var(--gray);
        margin-top: 0.75rem;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem 2rem;
    }

    .empty-icon {
        width: 64px;
        height: 64px;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state h3 {
        font-size: 1.25rem;
        color: var(--dark);
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: var(--gray);
        margin-bottom: 1.5rem;
    }

    .create-button {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        background: var(--primary);
        color: white;
        border-radius: var(--border-radius);
        font-weight: 500;
        text-decoration: none;
        transition: all 0.2s;
    }

    .create-button:hover {
        background: var(--primary-dark);
    }

    /* Pagination */
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin-top: 2rem;
    }

    .page-link {
        padding: 0.5rem 1rem;
        background: var(--light);
        border-radius: var(--border-radius);
        color: var(--dark);
        text-decoration: none;
        font-size: 0.875rem;
        transition: all 0.2s;
    }

    .page-link:hover {
        background: var(--primary);
        color: white;
    }

    .page-info {
        font-size: 0.875rem;
        color: var(--gray);
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .stats-container {
            flex-direction: column;
        }

        .notes-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Function to convert HTML to formatted text
        function htmlToFormattedText(html) {
            const temp = document.createElement('div');
            temp.innerHTML = html;

            temp.querySelectorAll('strong, b').forEach(el => {
                el.replaceWith(`*${el.textContent}*`);
            });

            temp.querySelectorAll('em, i').forEach(el => {
                el.replaceWith(`_${el.textContent}_`);
            });

            temp.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(el => {
                const text = el.textContent.toUpperCase();
                const underline = '='.repeat(text.length);
                el.replaceWith(`\n\n${text}\n${underline}\n\n`);
            });

            temp.querySelectorAll('ul').forEach(ul => {
                let bullets = '';
                ul.querySelectorAll('li').forEach(li => {
                    bullets += `â€¢ ${li.textContent}\n`;
                });
                ul.replaceWith(`\n${bullets}\n`);
            });

            temp.querySelectorAll('ol').forEach(ol => {
                let numbers = '';
                ol.querySelectorAll('li').forEach((li, i) => {
                    numbers += `${i+1}. ${li.textContent}\n`;
                });
                ol.replaceWith(`\n${numbers}\n`);
            });

            temp.querySelectorAll('hr').forEach(hr => {
                hr.replaceWith('\n' + '-'.repeat(50) + '\n');
            });

            temp.innerHTML = temp.innerHTML.replace(/<br\s*\/?>/gi, '\n');

            let text = temp.textContent;
            text = text.replace(/\n{3,}/g, '\n\n');
            return text.trim();
        }

        // Set up download buttons
        document.querySelectorAll('.download-button').forEach(button => {
            button.addEventListener('click', function() {
                const title = this.getAttribute('data-title');
                const htmlContent = this.getAttribute('data-content');
                const card = this.closest('.note-card');

                const noteTitle = card.querySelector('.note-title')?.textContent || 'Untitled Note';
                const noteContent = htmlToFormattedText(htmlContent);
                const noteTags = Array.from(card.querySelectorAll('.tag')).map(tag => tag.textContent).join(', ');
                const noteDate = card.querySelector('.note-date')?.textContent || '';
                const isPinned = card.classList.contains('pinned') ? 'ðŸ“Œ ' : '';
                const isStarred = card.classList.contains('starred') ? 'â­ ' : '';

                const textContent = `
${'='.repeat(noteTitle.length + 4)}
  ${isPinned}${isStarred}${noteTitle.toUpperCase()}
${'='.repeat(noteTitle.length + 4)}

${noteContent}

${'-'.repeat(40)}
TAGS: ${noteTags || 'None'}
DATE: ${noteDate}
`.trim();

                const blob = new Blob([textContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                const cleanTitle = title.replace(/[^\w\s-]/g, '');
                a.download = (cleanTitle || 'note') + '.txt';

                document.body.appendChild(a);
                a.click();

                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            });
        });

        // Tag coloring
        const colors = ['#4f46e5', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];
        document.querySelectorAll('.tag').forEach(tag => {
            const text = tag.textContent.toLowerCase();
            let hash = 0;
            for (let i = 0; i < text.length; i++) {
                hash = text.charCodeAt(i) + ((hash << 5) - hash);
            }
            const colorIndex = Math.abs(hash) % colors.length;
            tag.style.backgroundColor = `${colors[colorIndex]}15`;
            tag.style.color = colors[colorIndex];
            tag.style.border = `1px solid ${colors[colorIndex]}30`;
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);

        // Check if this is the initial load (no query parameters)
        if (urlParams.toString() === '' && !sessionStorage.getItem('filtersModified')) {
            // Redirect to pinned view by default
            window.location.href = window.location.pathname + '?filter_pinned=true';
        }

        // When any filter link is clicked, set a flag
        document.querySelectorAll('[data-filter], .tag-pill, .sort-select').forEach(element => {
            element.addEventListener('click', function() {
                sessionStorage.setItem('filtersModified', 'true');
            });
        });
    });
</script>
{{ end }}