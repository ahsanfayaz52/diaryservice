{{ define "content" }}
<div class="full-width-form-container">
    <div class="full-width-form-card">
        <div class="form-header">
            <h1>
                <i class="fas fa-{{ if .Title }}edit{{ else }}plus-circle{{ end }}"></i>
                {{ if .Title }}Edit Note{{ else }}Create New Note{{ end }}
            </h1>
            <p class="form-subtitle">Organize your knowledge in a spacious editor</p>
        </div>

        <form method="post" class="full-width-form">
            <div class="form-columns">
                <!-- Left Column -->
                <div class="form-left-column">
                    <!-- Title Field -->
                    <div class="form-group">
                        <label for="title">Title</label>
                        <input type="text" id="title" name="title" value="{{ if .Title }}{{ .Title }}{{ end }}"
                               placeholder="What's this note about?" required autofocus>
                        <div class="error-message" id="title-error"></div>
                    </div>

                    <!-- Tags Field -->
                    <div class="form-group">
                        <label for="tags">Tags</label>
                        <input type="text" id="tags" name="tags" value="{{ if .Tags }}{{ .Tags }}{{ end }}"
                               placeholder="work, ideas, important (comma separated)">
                    </div>

                    <!-- Options -->
                    <div class="form-options">
                        <label class="option-toggle">
                            <input type="checkbox" name="is_pinned" {{ if .IsPinned }}checked{{ end }}>
                            <span class="toggle-slider"></span>
                            <span class="option-label">
                <i class="fas fa-thumbtack"></i> Pin Note
              </span>
                        </label>
                        <label class="option-toggle">
                            <input type="checkbox" name="is_starred" {{ if .IsStarred }}checked{{ end }}>
                            <span class="toggle-slider"></span>
                            <span class="option-label">
                <i class="fas fa-star"></i> Starred
              </span>
                        </label>
                    </div>
                </div>

                <!-- Right Column (Content) -->
                <div class="form-right-column">
                    <div class="form-group">
                        <div class="content-header">
                            <label for="content">Content</label>
                            <div class="ai-tools">
                                <button type="button" class="ai-btn" data-action="enhance">
                                    <i class="fas fa-magic"></i> Enhance
                                </button>
                                <button type="button" class="ai-btn" data-action="summarize">
                                    <i class="fas fa-compress-alt"></i> Summarize
                                </button>
                                <button type="button" class="ai-btn" data-action="fix">
                                    <i class="fas fa-spell-check"></i> Fix Grammar
                                </button>
                            </div>
                        </div>

                        <!-- Hidden field to store HTML content -->
                        <input type="hidden" name="content" id="content">

                        <!-- Quill editor container -->
                        <div id="quill-editor" style="min-height: 60vh;"></div>

                        <div class="error-message" id="content-error"></div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button type="submit" class="btn btn-save">
                    <i class="fas fa-save"></i> Save Note
                </button>
                <a href="/dashboard" class="btn btn-cancel">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<!-- AI Processing Modal -->
<div id="ai-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-robot"></i> Processing with AI</h3>
        </div>
        <div class="modal-body">
            <div class="loader"></div>
            <p id="ai-status">Enhancing your content...</p>
        </div>
    </div>
</div>


<style>
    :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --primary-light: #a5b4fc;
        --text: #1f2937;
        --text-light: #6b7280;
        --background: #f9fafb;
        --card-bg: #ffffff;
        --border: #e5e7eb;
        --border-focus: #a5b4fc;
        --error: #ef4444;
        --success: #10b981;
        --radius: 8px;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Full Width Layout */
    .full-width-form-container {
        width: 100%;
        padding: 1rem;
        background-color: var(--background);
        min-height: calc(100vh - 60px);
    }

    .full-width-form-card {
        width: 100%;
        max-width: none;
        background: var(--card-bg);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 2rem;
        margin: 0 auto;
    }

    /* Form Columns */
    .form-columns {
        display: flex;
        gap: 2rem;
        width: 100%;
    }

    .form-left-column {
        flex: 0 0 300px;
    }

    .form-right-column {
        flex: 1;
        min-width: 0;
    }

    /* Header */
    .form-header {
        margin-bottom: 2rem;
    }

    .form-header h1 {
        color: var(--primary-dark);
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .form-subtitle {
        color: var(--text-light);
        font-size: 0.95rem;
    }

    /* Form Groups */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text);
        font-size: 0.95rem;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        font-size: 1rem;
        color: var(--text);
        transition: all 0.2s ease;
        background-color: var(--card-bg);
    }

    .form-group input:focus,
    .form-group textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-light);
        outline: none;
    }

    .form-group input::placeholder,
    .form-group textarea::placeholder {
        color: var(--text-light);
        opacity: 0.7;
    }

    /* Content Area */
    .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .form-group textarea {
        min-height: 60vh;
        resize: vertical;
        line-height: 1.6;
    }

    /* AI Tools */
    .ai-tools {
        display: flex;
        gap: 0.5rem;
    }

    .ai-btn {
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary-dark);
        border: none;
        border-radius: var(--radius);
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .ai-btn:hover {
        background: rgba(99, 102, 241, 0.2);
    }

    /* Toggle Switches */
    .form-options {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 1rem;
    }

    .option-toggle {
        display: flex;
        align-items: center;
        cursor: pointer;
        position: relative;
        user-select: none;
    }

    .option-toggle input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }

    .toggle-slider {
        position: relative;
        height: 20px;
        width: 40px;
        background-color: #e5e7eb;
        border-radius: 20px;
        transition: .2s;
        margin-right: 0.75rem;
    }

    .toggle-slider:before {
        content: "";
        position: absolute;
        height: 16px;
        width: 16px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        border-radius: 50%;
        transition: .2s;
    }

    .option-toggle input:checked + .toggle-slider {
        background-color: var(--primary);
    }

    .option-toggle input:checked + .toggle-slider:before {
        transform: translateX(20px);
    }

    .option-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text);
    }

    /* Buttons */
    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border);
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border: none;
    }

    .btn-save {
        background: var(--primary);
        color: white;
    }

    .btn-save:hover {
        background: var(--primary-dark);
    }

    .btn-cancel {
        background: var(--background);
        color: var(--text);
        border: 1px solid var(--border);
    }

    .btn-cancel:hover {
        background: #e5e7eb;
    }

    /* Error Messages */
    .error-message {
        color: var(--error);
        font-size: 0.85rem;
        margin-top: 0.5rem;
        display: none;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: var(--radius);
        padding: 2rem;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        text-align: center;
    }

    .modal-header h3 {
        color: var(--primary-dark);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .loader {
        width: 50px;
        height: 50px;
        margin: 1rem auto;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    #ai-status {
        margin-top: 1rem;
        color: var(--text);
    }

    /* Add these styles to your existing CSS */
    #quill-editor .ql-editor {
        font-size: 1.1rem;
        line-height: 1.8;
        color: #333;
        position: relative;
        z-index: 1;
    }


    #quill-editor .ql-editor h1,
    #quill-editor .ql-editor h2,
    #quill-editor .ql-editor h3 {
        margin: 1.5em 0 0.8em;
        color: #2c3e50;
    }

    #quill-editor .ql-editor p {
        margin-bottom: 1.2em;
    }

    #quill-editor .ql-editor ul,
    #quill-editor .ql-editor ol {
        margin-bottom: 1.2em;
        padding-left: 2em;
    }

    #quill-editor .ql-editor li {
        margin-bottom: 0.5em;
    }

    #quill-editor .ql-editor blockquote {
        border-left: 4px solid #6366f1;
        padding-left: 1em;
        margin-left: 0;
        color: #555;
        font-style: italic;
    }

    #quill-editor .ql-editor pre {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 1em;
        overflow-x: auto;
        margin: 1.5em 0;
    }


    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 992px) {
        .form-columns {
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-left-column {
            flex: 1;
        }

        .form-group textarea {
            min-height: 400px;
        }
    }

    @media (max-width: 768px) {
        .full-width-form-card {
            padding: 1.5rem;
        }

        .ai-tools {
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .ai-btn {
            margin-bottom: 0.5rem;
        }
    }
</style>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Quill with enhanced options
        const quill = new Quill('#quill-editor', {
            theme: 'snow',
            placeholder: 'Write your thoughts here...',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['blockquote'],
                    ['clean']
                ]
            },
            formats: [
                'header',
                'bold', 'italic', 'underline', 'strike',
                'list', 'bullet',
                'blockquote'
            ]
        });

        // Set initial content from backend with proper HTML handling
        const initialContent = {{ if .Content }}{{ printf "%v" .Content | safeHTML }}{{ else }}''{{ end }};
        if (initialContent && initialContent.trim() !== '') {
            setTimeout(() => {
                try {
                    // First try to parse as Delta
                    try {
                        const delta = JSON.parse(initialContent);
                        quill.setContents(delta);
                    } catch (e) {
                        // If not Delta, treat as HTML
                        const container = document.createElement('div');
                        container.innerHTML = initialContent;

                        // Ensure basic formatting
                        if (!container.querySelector('p, div, h1, h2, h3')) {
                            const formattedContent = initialContent
                                .split('\n\n')
                                .map(p => p.trim() ? `<p>${p}</p>` : '')
                                .join('');
                            quill.clipboard.dangerouslyPasteHTML(formattedContent);
                        } else {
                            quill.clipboard.dangerouslyPasteHTML(container.innerHTML);
                        }
                    }
                } catch (error) {
                    console.error('Error initializing editor content:', error);
                    quill.setText(initialContent);
                }
            }, 100);
        }

        // DOM elements
        const contentInput = document.getElementById('content');
        const titleInput = document.getElementById('title');
        const titleError = document.getElementById('title-error');
        const contentError = document.getElementById('content-error');
        const aiButtons = document.querySelectorAll('.ai-btn');
        const modal = document.getElementById('ai-modal');
        const aiStatus = document.getElementById('ai-status');
        const form = document.querySelector('form');

        // Enhanced AI processing function
        async function processWithAI(action) {
            // Get current content as HTML
            const htmlContent = quill.root.innerHTML;

            if (!quill.getText().trim()) {
                contentError.textContent = 'Please enter some content first';
                contentError.style.display = 'block';
                return;
            }

            showModal(true);
            aiStatus.textContent = {
                enhance: 'Enhancing your content with beautiful formatting...',
                summarize: 'Creating a well-structured summary...',
                fix: 'Improving grammar while preserving formatting...'
            }[action] || 'Processing...';

            try {
                const response = await fetch('/ai/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: htmlContent,
                        action: action
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }

                const result = await response.json();

                if (result.text) {
                    // Process the AI response to ensure beautiful formatting
                    let processedHTML = formatAIResponse(result.text, action);

                    // Update editor with smooth transition
                    quill.enable(false);
                    const range = quill.getSelection();
                    quill.clipboard.dangerouslyPasteHTML(processedHTML);
                    if (range) quill.setSelection(range.index, range.length);
                    quill.enable(true);

                    // Scroll to top to show changes
                    quill.scroll.domNode.scrollTop = 0;
                }

                aiStatus.textContent = 'Enhancement complete!';
                setTimeout(() => showModal(false), 1000);
            } catch (error) {
                console.error('AI processing error:', error);
                aiStatus.textContent = 'Error: ' + error.message;
                setTimeout(() => showModal(false), 2000);
            }
        }

        // Format AI response for beautiful display
        function formatAIResponse(html, action) {
            const container = document.createElement('div');
            container.innerHTML = html;

            // Ensure proper paragraph spacing
            const paragraphs = container.querySelectorAll('p');
            paragraphs.forEach(p => {
                if (!p.innerHTML.trim()) p.remove();
                else if (!p.style.marginBottom) {
                    p.style.marginBottom = '1.2em';
                }
            });

            // Add special formatting based on action
            switch (action) {
                case 'enhance':
                    // Ensure headers have proper spacing
                    container.querySelectorAll('h1, h2, h3').forEach(header => {
                        if (!header.style.marginTop) {
                            header.style.marginTop = '1.5em';
                            header.style.marginBottom = '0.8em';
                        }
                    });
                    break;

                case 'summarize':
                    // Ensure lists are properly formatted
                    container.querySelectorAll('ul, ol').forEach(list => {
                        if (!list.style.paddingLeft) {
                            list.style.paddingLeft = '2em';
                            list.style.marginBottom = '1.2em';
                        }
                    });
                    break;
            }

            // If no HTML tags found, create proper paragraphs
            if (container.children.length === 0) {
                const formatted = html
                    .split('\n\n')
                    .map(p => `<p style="margin-bottom:1.2em">${p}</p>`)
                    .join('');
                container.innerHTML = formatted;
            }

            return container.innerHTML;
        }

        // AI button handlers
        aiButtons.forEach(button => {
            button.addEventListener('click', () => {
                const action = button.dataset.action;
                processWithAI(action);
            });
        });

        // Form validation and submission
        form.addEventListener('submit', function (event) {
            let valid = true;

            const title = titleInput.value.trim();
            const content = quill.getText().trim();

            // Validate title
            if (!title) {
                titleError.textContent = 'Title is required';
                titleError.style.display = 'block';
                valid = false;
            } else {
                titleError.style.display = 'none';
            }

            // Validate content
            if (!content) {
                contentError.textContent = 'Content is required';
                contentError.style.display = 'block';
                valid = false;
            } else {
                contentError.style.display = 'none';
            }

            // Save HTML content
            contentInput.value = quill.root.innerHTML;

            if (!valid) {
                event.preventDefault();
            }
        });

        // Modal control
        function showModal(show) {
            modal.style.display = show ? 'flex' : 'none';
            if (show) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        quill.root.addEventListener('paste', function(e) {
            const clipboardData = e.clipboardData || window.clipboardData;
            const html = clipboardData.getData('text/html');
            const text = clipboardData.getData('text/plain');

            // If HTML is available, let Quill handle it normally
            if (html) {
                return; // Do NOT preventDefault
            }

            // If no HTML (plain text), handle it manually
            e.preventDefault();
            const range = quill.getSelection(true);

            // Split by lines and insert line-by-line
            const lines = text.split('\n');
            lines.forEach((line, idx) => {
                quill.insertText(range.index, line);
                range.index += line.length;
                if (idx < lines.length - 1) {
                    quill.insertText(range.index, '\n');
                    range.index += 1;
                }
            });
        });

    });
</script>


{{ end }}
