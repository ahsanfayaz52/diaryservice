{{ define "content" }}
<div class="full-width-form-container">
    <div class="full-width-form-card">
        <div class="form-header">
            <h1>
                <i class="fas fa-{{ if .Title }}edit{{ else }}plus-circle{{ end }}"></i>
                {{ if .Title }}Edit Note{{ else }}Create New Note{{ end }}
            </h1>
            <p class="form-subtitle">Organize your knowledge in a spacious editor</p>
        </div>

        <form method="post" class="full-width-form">
            <div class="form-columns">
                <!-- Left Column -->
                <div class="form-left-column">
                    <!-- Title Field -->
                    <div class="form-group">
                        <label for="title">Title</label>
                        <input type="text" id="title" name="title" value="{{ if .Title }}{{ .Title }}{{ end }}"
                               placeholder="What's this note about?" required autofocus>
                        <div class="error-message" id="title-error"></div>
                    </div>

                    <!-- Tags Field -->
                    <div class="form-group">
                        <label for="tags">Tags</label>
                        <input type="text" id="tags" name="tags" value="{{ if .Tags }}{{ .Tags }}{{ end }}"
                               placeholder="work, ideas, important (comma separated)">
                    </div>

                    <!-- Meeting Controls -->
                    <div class="meeting-controls">
                        <h3><i class="fas fa-users"></i> Meeting Mode</h3>
                        <div class="meeting-buttons">
                            <button type="button" id="start-meeting" class="btn btn-meeting">
                                <i class="fas fa-microphone"></i> Start Meeting
                            </button>
                            <button type="button" id="stop-meeting" class="btn btn-meeting" disabled>
                                <i class="fas fa-stop"></i> Stop
                            </button>
                            <button type="button" id="summarize-meeting" class="btn btn-meeting" disabled>
                                <i class="fas fa-robot"></i> Summarize
                            </button>
                        </div>
                        <div class="meeting-status" id="meeting-status">
                            Meeting not started
                        </div>
                        <div class="speaker-identification">
                            <label>
                                <input type="checkbox" id="identify-speakers">
                                Identify different speakers
                            </label>
                        </div>
                    </div>

                    <!-- Options -->
                    <div class="form-options">
                        <label class="option-toggle">
                            <input type="checkbox" name="is_pinned" {{ if .IsPinned }}checked{{ end }}>
                            <span class="toggle-slider"></span>
                            <span class="option-label">
                                <i class="fas fa-thumbtack"></i> Pin Note
                            </span>
                        </label>
                        <label class="option-toggle">
                            <input type="checkbox" name="is_starred" {{ if .IsStarred }}checked{{ end }}>
                            <span class="toggle-slider"></span>
                            <span class="option-label">
                                <i class="fas fa-star"></i> Starred
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Right Column (Content) -->
                <div class="form-right-column">
                    <div class="form-group">
                        <div class="content-header">
                            <label for="content">Content</label>
                            <div class="ai-tools">
                                <button type="button" class="ai-btn" data-action="enhance">
                                    <i class="fas fa-magic"></i> Enhance
                                </button>
                                <button type="button" class="ai-btn" data-action="summarize">
                                    <i class="fas fa-compress-alt"></i> Summarize
                                </button>
                                <button type="button" class="ai-btn" data-action="fix">
                                    <i class="fas fa-spell-check"></i> Fix Grammar
                                </button>
                            </div>
                        </div>

                        <!-- Hidden field to store HTML content -->
                        <input type="hidden" name="content" id="content">

                        <!-- Quill editor container -->
                        <div id="quill-editor" style="min-height: 60vh;"></div>

                        <div class="error-message" id="content-error"></div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button type="submit" class="btn btn-save">
                    <i class="fas fa-save"></i> Save Note
                </button>
                <a href="/dashboard" class="btn btn-cancel">
                    <i class="fas fa-times"></i> Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<!-- AI Processing Modal -->
<div id="ai-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-robot"></i> Processing with AI</h3>
        </div>
        <div class="modal-body">
            <div class="loader"></div>
            <p id="ai-status">Enhancing your content...</p>
        </div>
    </div>
</div>

<!-- Meeting Summary Modal -->
<div id="summary-modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3><i class="fas fa-file-alt"></i> Meeting Summary</h3>
            <button type="button" class="close-summary">&times;</button>
        </div>
        <div class="modal-body">
            <div id="summary-content" style="text-align: left; max-height: 60vh; overflow-y: auto;"></div>
            <div class="summary-actions">
                <button type="button" id="insert-summary" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Insert into Note
                </button>
                <button type="button" id="discard-summary" class="btn btn-cancel">
                    <i class="fas fa-times"></i> Discard
                </button>
            </div>
        </div>
    </div>
</div>


<style>
    :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --primary-light: #a5b4fc;
        --text: #1f2937;
        --text-light: #6b7280;
        --background: #f9fafb;
        --card-bg: #ffffff;
        --border: #e5e7eb;
        --border-focus: #a5b4fc;
        --error: #ef4444;
        --success: #10b981;
        --radius: 8px;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Add these new styles to your existing CSS */
    .meeting-controls {
        background: #f8f9fa;
        border-radius: var(--radius);
        padding: 1rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border);
    }

    .meeting-controls h3 {
        font-size: 1rem;
        margin-bottom: 1rem;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .meeting-buttons {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .btn-meeting {
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary-dark);
        border: none;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        flex: 1;
        min-width: 120px;
    }

    .btn-meeting:hover {
        background: rgba(99, 102, 241, 0.2);
    }

    .btn-meeting:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .meeting-status {
        font-size: 0.85rem;
        color: var(--text-light);
        padding: 0.5rem;
        border-radius: var(--radius);
        background: white;
        text-align: center;
        margin-bottom: 0.5rem;
    }

    .speaker-identification {
        font-size: 0.85rem;
        color: var(--text-light);
    }

    .speaker-identification label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
    }

    .speaker-identification input {
        margin: 0;
    }

    /* Transcript styling */
    .transcript-line {
        margin-bottom: 0.5rem;
        line-height: 1.5;
    }

    .transcript-speaker {
        font-weight: bold;
        color: var(--primary-dark);
    }

    .transcript-time {
        color: var(--text-light);
        font-size: 0.8rem;
        margin-right: 0.5rem;
    }

    /* Summary modal specific styles */
    .summary-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
    }

    .close-summary {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-light);
        position: absolute;
        top: 1rem;
        right: 1rem;
    }

    #summary-content {
        padding: 1rem;
        background: var(--background);
        border-radius: var(--radius);
    }

    #summary-content h3 {
        color: var(--primary-dark);
        margin-top: 1rem;
        margin-bottom: 0.5rem;
    }

    #summary-content ul {
        padding-left: 1.5rem;
    }

    #summary-content li {
        margin-bottom: 0.5rem;
    }

    /* Full Width Layout */
    .full-width-form-container {
        width: 100%;
        padding: 1rem;
        background-color: var(--background);
        min-height: calc(100vh - 60px);
    }

    .full-width-form-card {
        width: 100%;
        max-width: none;
        background: var(--card-bg);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 2rem;
        margin: 0 auto;
    }

    /* Form Columns */
    .form-columns {
        display: flex;
        gap: 2rem;
        width: 100%;
    }

    .form-left-column {
        flex: 0 0 300px;
    }

    .form-right-column {
        flex: 1;
        min-width: 0;
    }

    /* Header */
    .form-header {
        margin-bottom: 2rem;
    }

    .form-header h1 {
        color: var(--primary-dark);
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .form-subtitle {
        color: var(--text-light);
        font-size: 0.95rem;
    }

    /* Form Groups */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text);
        font-size: 0.95rem;
    }

    .form-group input,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        font-size: 1rem;
        color: var(--text);
        transition: all 0.2s ease;
        background-color: var(--card-bg);
    }

    .form-group input:focus,
    .form-group textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px var(--primary-light);
        outline: none;
    }

    .form-group input::placeholder,
    .form-group textarea::placeholder {
        color: var(--text-light);
        opacity: 0.7;
    }

    /* Content Area */
    .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .form-group textarea {
        min-height: 60vh;
        resize: vertical;
        line-height: 1.6;
    }

    /* AI Tools */
    .ai-tools {
        display: flex;
        gap: 0.5rem;
    }

    .ai-btn {
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary-dark);
        border: none;
        border-radius: var(--radius);
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
    }

    .ai-btn:hover {
        background: rgba(99, 102, 241, 0.2);
    }

    /* Toggle Switches */
    .form-options {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 1rem;
    }

    .option-toggle {
        display: flex;
        align-items: center;
        cursor: pointer;
        position: relative;
        user-select: none;
    }

    .option-toggle input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }

    .toggle-slider {
        position: relative;
        height: 20px;
        width: 40px;
        background-color: #e5e7eb;
        border-radius: 20px;
        transition: .2s;
        margin-right: 0.75rem;
    }

    .toggle-slider:before {
        content: "";
        position: absolute;
        height: 16px;
        width: 16px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        border-radius: 50%;
        transition: .2s;
    }

    .option-toggle input:checked + .toggle-slider {
        background-color: var(--primary);
    }

    .option-toggle input:checked + .toggle-slider:before {
        transform: translateX(20px);
    }

    .option-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text);
    }

    /* Buttons */
    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border);
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border: none;
    }

    .btn-save {
        background: var(--primary);
        color: white;
    }

    .btn-save:hover {
        background: var(--primary-dark);
    }

    .btn-cancel {
        background: var(--background);
        color: var(--text);
        border: 1px solid var(--border);
    }

    .btn-cancel:hover {
        background: #e5e7eb;
    }

    /* Error Messages */
    .error-message {
        color: var(--error);
        font-size: 0.85rem;
        margin-top: 0.5rem;
        display: none;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        border-radius: var(--radius);
        padding: 2rem;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        text-align: center;
    }

    .modal-header h3 {
        color: var(--primary-dark);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .loader {
        width: 50px;
        height: 50px;
        margin: 1rem auto;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    #ai-status {
        margin-top: 1rem;
        color: var(--text);
    }

    /* Add these styles to your existing CSS */
    #quill-editor .ql-editor {
        font-size: 1.1rem;
        line-height: 1.8;
        color: #333;
        position: relative;
        z-index: 1;
    }


    #quill-editor .ql-editor h1,
    #quill-editor .ql-editor h2,
    #quill-editor .ql-editor h3 {
        margin: 1.5em 0 0.8em;
        color: #2c3e50;
    }

    #quill-editor .ql-editor p {
        margin-bottom: 1.2em;
    }

    #quill-editor .ql-editor ul,
    #quill-editor .ql-editor ol {
        margin-bottom: 1.2em;
        padding-left: 2em;
    }

    #quill-editor .ql-editor li {
        margin-bottom: 0.5em;
    }

    #quill-editor .ql-editor blockquote {
        border-left: 4px solid #6366f1;
        padding-left: 1em;
        margin-left: 0;
        color: #555;
        font-style: italic;
    }

    #quill-editor .ql-editor pre {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 1em;
        overflow-x: auto;
        margin: 1.5em 0;
    }


    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 992px) {
        .form-columns {
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-left-column {
            flex: 1;
        }

        .form-group textarea {
            min-height: 400px;
        }
    }

    @media (max-width: 768px) {
        .full-width-form-card {
            padding: 1.5rem;
        }

        .ai-tools {
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .ai-btn {
            margin-bottom: 0.5rem;
        }
    }
</style>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Quill editor
        const quill = new Quill('#quill-editor', {
            theme: 'snow',
            placeholder: 'Write your thoughts here...',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['blockquote'],
                    ['clean']
                ]
            },
            formats: [
                'header',
                'bold', 'italic', 'underline', 'strike',
                'list', 'bullet',
                'blockquote'
            ]
        });

        // Set initial content
        const initialContent = {{ if .Content }}{{ printf "%v" .Content | safeHTML }}{{ else }}''{{ end }};
        if (initialContent && initialContent.trim() !== '') {
            setTimeout(() => {
                try {
                    try {
                        const delta = JSON.parse(initialContent);
                        quill.setContents(delta);
                    } catch (e) {
                        const container = document.createElement('div');
                        container.innerHTML = initialContent;
                        if (!container.querySelector('p, div, h1, h2, h3')) {
                            const formattedContent = initialContent
                                .split('\n\n')
                                .map(p => p.trim() ? `<p>${p}</p>` : '')
                                .join('');
                            quill.clipboard.dangerouslyPasteHTML(formattedContent);
                        } else {
                            quill.clipboard.dangerouslyPasteHTML(container.innerHTML);
                        }
                    }
                } catch (error) {
                    console.error('Error initializing editor content:', error);
                    quill.setText(initialContent);
                }
            }, 100);
        }

        // DOM elements
        const contentInput = document.getElementById('content');
        const titleInput = document.getElementById('title');
        const titleError = document.getElementById('title-error');
        const contentError = document.getElementById('content-error');
        const aiButtons = document.querySelectorAll('.ai-btn');
        const modal = document.getElementById('ai-modal');
        const aiStatus = document.getElementById('ai-status');
        const form = document.querySelector('form');

        // ===== Meeting Transcription Feature =====
        const startMeetingBtn = document.getElementById('start-meeting');
        const stopMeetingBtn = document.getElementById('stop-meeting');
        const summarizeMeetingBtn = document.getElementById('summarize-meeting');
        const meetingStatus = document.getElementById('meeting-status');
        const identifySpeakersCheckbox = document.getElementById('identify-speakers');
        const summaryModal = document.getElementById('summary-modal');
        const summaryContent = document.getElementById('summary-content');
        const insertSummaryBtn = document.getElementById('insert-summary');
        const closeSummaryBtn = document.querySelector('.close-summary');
        const discardSummaryBtn = document.getElementById('discard-summary');

        let meetingInterval;
        let meetingTranscript = [];
        let isMeetingRunning = false;
        let speechRecognition;
        let lastSpeaker = '';
        let speakerCount = 0;
        let speakerMap = {};

        let recognitionRestartAttempts = 0;
        const MAX_RESTART_ATTEMPTS = 12;
        const RESTART_DELAY = 1000; // 1 second delay between restart attempts

        // Initialize speech recognition
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                meetingStatus.textContent = "Speech recognition not supported in this browser";
                return false;
            }

            speechRecognition = new SpeechRecognition();
            speechRecognition.continuous = true;
            speechRecognition.interimResults = true;
            speechRecognition.maxAlternatives = 1;

            // Add error handler to restart recognition if it stops unexpectedly
            speechRecognition.onend = () => {
                if (isMeetingRunning && recognitionRestartAttempts < MAX_RESTART_ATTEMPTS) {
                    console.log('Speech recognition ended, attempting to restart...');
                    recognitionRestartAttempts++;
                    meetingStatus.textContent = `Reconnecting speech recognition (attempt ${recognitionRestartAttempts})...`;
                    console.log(meetingStatus.textContent)

                    setTimeout(() => {
                        try {
                            speechRecognition.start();
                            console.log('Recognition restarted successfully');
                            meetingStatus.textContent = `Meeting in progress (reconnected)`;
                        } catch (e) {
                            console.error('Error restarting recognition:', e);
                            if (recognitionRestartAttempts >= MAX_RESTART_ATTEMPTS) {
                                meetingStatus.textContent = "Error: Failed to reconnect after multiple attempts";
                                stopMeeting();
                            }
                        }
                    }, RESTART_DELAY);
                }
            };

            speechRecognition.onresult = (event) => {
                // Reset restart attempts counter on successful recognition
                recognitionRestartAttempts = 0;

                const identifySpeakers = identifySpeakersCheckbox.checked;
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (finalTranscript) {
                    // Speaker identification logic
                    let speakerTag = '';
                    if (identifySpeakers) {
                        // Simple speaker change detection
                        if (!lastSpeaker || Math.random() > 0.7) { // Simulate speaker change
                            speakerCount++;
                            lastSpeaker = `Speaker ${speakerCount}`;
                            speakerMap[lastSpeaker] = speakerMap[lastSpeaker] || getRandomColor();
                        }
                        speakerTag = `<span class="transcript-speaker" style="color:${speakerMap[lastSpeaker]}">${lastSpeaker}: </span>`;
                    }

                    const timestamp = new Date().toLocaleTimeString();
                    const transcriptEntry = {
                        speaker: lastSpeaker,
                        text: finalTranscript,
                        time: timestamp,
                        html: `<div class="transcript-line"><span class="transcript-time">${timestamp}</span>${speakerTag}${finalTranscript}</div>`
                    };

                    meetingTranscript.push(transcriptEntry);

                    // Append to editor
                    const currentContent = quill.root.innerHTML;
                    quill.clipboard.dangerouslyPasteHTML(
                        currentContent + transcriptEntry.html
                    );

                    // Scroll to bottom
                    quill.scroll.domNode.scrollTop = quill.scroll.domNode.scrollHeight;
                }
            };

            speechRecognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);

                // Handle specific error codes
                if (event.error === 'network') {
                    meetingStatus.textContent = "Network error - trying to reconnect...";
                    if (isMeetingRunning && recognitionRestartAttempts < MAX_RESTART_ATTEMPTS) {
                        setTimeout(() => {
                            try {
                                speechRecognition.start();
                            } catch (e) {
                                console.error('Error restarting after network error:', e);
                            }
                        }, RESTART_DELAY);
                    }
                } else {
                    meetingStatus.textContent = `Error: ${event.error}`;
                    if (event.error === 'no-speech' || event.error === 'audio-capture') {
                        // These errors might be recoverable
                        if (isMeetingRunning && recognitionRestartAttempts < MAX_RESTART_ATTEMPTS) {
                            setTimeout(() => {
                                try {
                                    speechRecognition.start();
                                } catch (e) {
                                    console.error('Error restarting after error:', e);
                                }
                            }, RESTART_DELAY);
                        }
                    } else {
                        // For other errors, stop the meeting
                        stopMeeting();
                    }
                }
            };

            return true;
        }

        // In your template script section
        function startMeeting() {
            const meetingLimitExceeded = {{ if .MeetingLimitExceeded }}true{{ else }}false{{ end }};

            if (meetingLimitExceeded) {
                alert("Free plan limit reached (5 minutes). Please upgrade to record longer meetings.");
                stopMeeting()
                return;
            }

            // Existing start meeting code
            if (!isMeetingRunning) {
                recognitionRestartAttempts = 0;
                if (!initSpeechRecognition()) {
                    return;
                }

                try {
                    speechRecognition.start();
                    isMeetingRunning = true;
                    meetingStatus.textContent = "Meeting in progress...";
                    startMeetingBtn.disabled = true;
                    stopMeetingBtn.disabled = false;
                    summarizeMeetingBtn.disabled = true;
                    meetingTranscript = [];

                    // Start timer
                    let seconds = 0;
                    meetingInterval = setInterval(() => {
                        seconds++;
                        const minutes = Math.floor(seconds / 60);
                        const remainingSeconds = seconds % 60;
                        meetingStatus.textContent = `Meeting in progress (${minutes}m ${remainingSeconds}s)...`;

                        // Check if free user has reached 5 minutes
                        if (!{{ if .IsSubscribed }}true{{ else }}false{{ end }} && seconds >= 300) {
                            stopMeeting();
                            alert("Free plan meeting limit reached (5 minutes). Meeting stopped automatically.");
                        }
                    }, 1000);

                    // Update database with meeting start time
                    fetch('/api/meeting/start', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    }).catch(err => console.error('Error recording meeting start:', err));

                } catch (error) {
                    console.error('Error starting meeting:', error);
                    meetingStatus.textContent = "Error starting meeting";
                }
            }
        }

        function stopMeeting() {
            if (!isMeetingRunning) return;

            try {
                isMeetingRunning = false;
                recognitionRestartAttempts = MAX_RESTART_ATTEMPTS;

                if (speechRecognition) {
                    speechRecognition.onend = null;
                    speechRecognition.stop();
                }
                clearInterval(meetingInterval);
                meetingStatus.textContent = "Meeting ended. Ready to summarize.";
                startMeetingBtn.disabled = false;
                stopMeetingBtn.disabled = true;
                summarizeMeetingBtn.disabled = false;

                // Update database with meeting duration
                fetch('/api/meeting/end', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                }).catch(err => console.error('Error recording meeting end:', err));

            } catch (error) {
                console.error('Error stopping meeting:', error);
            }
        }

        async function summarizeMeeting() {
            if (meetingTranscript.length === 0) {
                meetingStatus.textContent = "No transcript to summarize";
                return;
            }

            showModal(true);
            aiStatus.textContent = "Analyzing meeting transcript and generating summary...";

            try {
                // Prepare transcript for API
                const transcriptText = meetingTranscript.map(entry =>
                    `${entry.speaker ? entry.speaker + ': ' : ''}${entry.text}`
                ).join('\n');

                // Call your actual API endpoint
                const response = await fetch('/ai/summarize-meeting', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        transcript: transcriptText
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const result = await response.json();

                // Display summary
                summaryContent.innerHTML = `
                <h3>Meeting Summary</h3>
                <p>${result.summary || 'No summary generated'}</p>

                <h3>Key Points</h3>
                <ul>
                    ${(result.key_points || ['No key points']).map(point => `<li>${point}</li>`).join('')}
                </ul>

                <h3>Action Items</h3>
                <ul>
                    ${(result.action_items || ['No action items']).map(item => `<li>${item}</li>`).join('')}
                </ul>
            `;

                showModal(false);
                summaryModal.style.display = 'flex';

            } catch (error) {
                console.error('Error summarizing meeting:', error);
                aiStatus.textContent = "Error generating summary: " + error.message;
                setTimeout(() => showModal(false), 2000);
            }
        }

        function insertSummary() {
            const summaryHtml = summaryContent.innerHTML;
            quill.clipboard.dangerouslyPasteHTML(summaryHtml);
            summaryModal.style.display = 'none';
        }

        function discardSummary() {
            summaryModal.style.display = 'none';
        }

        // Event listeners for meeting controls
        startMeetingBtn.addEventListener('click', startMeeting);
        stopMeetingBtn.addEventListener('click', stopMeeting);
        summarizeMeetingBtn.addEventListener('click', summarizeMeeting);
        insertSummaryBtn.addEventListener('click', insertSummary);
        closeSummaryBtn.addEventListener('click', discardSummary);
        discardSummaryBtn.addEventListener('click', discardSummary);

        // ===== Existing AI Processing Functionality =====
        async function processWithAI(action) {
            const htmlContent = quill.root.innerHTML;

            if (!quill.getText().trim()) {
                contentError.textContent = 'Please enter some content first';
                contentError.style.display = 'block';
                return;
            }

            showModal(true);
            aiStatus.textContent = {
                enhance: 'Enhancing your content with beautiful formatting...',
                summarize: 'Creating a well-structured summary...',
                fix: 'Improving grammar while preserving formatting...'
            }[action] || 'Processing...';

            try {
                const response = await fetch('/ai/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: htmlContent,
                        action: action
                    })
                });

                if (!response.ok) throw new Error(`Server responded with ${response.status}`);

                const result = await response.json();

                if (result.text) {
                    let processedHTML = formatAIResponse(result.text, action);
                    quill.enable(false);
                    const range = quill.getSelection();
                    quill.clipboard.dangerouslyPasteHTML(processedHTML);
                    if (range) quill.setSelection(range.index, range.length);
                    quill.enable(true);
                    quill.scroll.domNode.scrollTop = 0;
                }

                aiStatus.textContent = 'Enhancement complete!';
                setTimeout(() => showModal(false), 1000);
            } catch (error) {
                console.error('AI processing error:', error);
                aiStatus.textContent = 'Error: ' + error.message;
                setTimeout(() => showModal(false), 2000);
            }
        }

        function formatAIResponse(html, action) {
            const container = document.createElement('div');
            container.innerHTML = html;

            container.querySelectorAll('p').forEach(p => {
                if (!p.innerHTML.trim()) p.remove();
                else if (!p.style.marginBottom) p.style.marginBottom = '1.2em';
            });

            switch (action) {
                case 'enhance':
                    container.querySelectorAll('h1, h2, h3').forEach(header => {
                        if (!header.style.marginTop) {
                            header.style.marginTop = '1.5em';
                            header.style.marginBottom = '0.8em';
                        }
                    });
                    break;
                case 'summarize':
                    container.querySelectorAll('ul, ol').forEach(list => {
                        if (!list.style.paddingLeft) {
                            list.style.paddingLeft = '2em';
                            list.style.marginBottom = '1.2em';
                        }
                    });
                    break;
            }

            if (container.children.length === 0) {
                const formatted = html
                    .split('\n\n')
                    .map(p => `<p style="margin-bottom:1.2em">${p}</p>`)
                    .join('');
                container.innerHTML = formatted;
            }

            return container.innerHTML;
        }

        // Existing AI button handlers
        aiButtons.forEach(button => {
            button.addEventListener('click', () => {
                const action = button.dataset.action;
                processWithAI(action);
            });
        });

        // Existing form validation
        form.addEventListener('submit', function(event) {
            let valid = true;

            const title = titleInput.value.trim();
            const content = quill.getText().trim();

            if (!title) {
                titleError.textContent = 'Title is required';
                titleError.style.display = 'block';
                valid = false;
            } else {
                titleError.style.display = 'none';
            }

            if (!content) {
                contentError.textContent = 'Content is required';
                contentError.style.display = 'block';
                valid = false;
            } else {
                contentError.style.display = 'none';
            }

            contentInput.value = quill.root.innerHTML;

            if (!valid) {
                event.preventDefault();
            }
        });

        // Existing modal control
        function showModal(show) {
            modal.style.display = show ? 'flex' : 'none';
            document.body.style.overflow = show ? 'hidden' : '';
        }

        // Existing paste handler
        quill.root.addEventListener('paste', function(e) {
            const clipboardData = e.clipboardData || window.clipboardData;
            const html = clipboardData.getData('text/html');
            const text = clipboardData.getData('text/plain');

            if (html) return;

            e.preventDefault();
            const range = quill.getSelection(true);
            const lines = text.split('\n');
            lines.forEach((line, idx) => {
                quill.insertText(range.index, line);
                range.index += line.length;
                if (idx < lines.length - 1) {
                    quill.insertText(range.index, '\n');
                    range.index += 1;
                }
            });
        });
    });
</script>


{{ end }}
